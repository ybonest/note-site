import * as React from 'react';
import {
  Switch,
  Route,
  Link,
  useHistory
} from "react-router-dom";
import { Synopsis, Details, Card } from '@components/styled';
import Comments from '@comments/Comments';

function getClient() {
  const host = window.location.host;
  const options = { owner: 'ybonest', repo: 'note-site' };
  if (host === 'localhost:8080') {
    Object.assign(options, {
      client_id: 'f67c609c5ee466c83cd2',
      client_secret: 'e956d15ba2761abad52e534424f52ba07ffbdbad',
      redirect_uri: 'http://localhost:8080/'
    }); 
  }
  if (host === 'me.ybonote.cn') {
    Object.assign(options, {
      client_id: '5962d91e68425e69e653',
      client_secret: '3231ff558fe41ba150fb868effdc099b7ac8d864',
      redirect_uri: 'https://me.ybonote.cn/'
    })
  }
  return options;
}

function markdown(markdown): React.FunctionComponent  {
  return () => {
    return <div dangerouslySetInnerHTML={{ __html: markdown }} />
  }
};

function RightContent() {
  return (
    <Card>
    </Card>
  );
}

export const List = ((sources: Record<string, string>[]): React.FunctionComponent => () => {
  const options = getClient();
  const history = useHistory();
  return (
    <React.Fragment>
      <Switch>
        <Route exact path='/'>
          <Synopsis key="list" content={{ display: 'none', padding: '0px' }}>
                {sources.map(source => (
                  <Link key={source.namehash} to={'/' + source.namehash}>
                    {React.createElement(markdown(source.content), { key: source.namehash })}
                  </Link>
              ))}
          </Synopsis>
          <RightContent />
        </Route>
      </Switch>
        <Switch>
          {sources.map(source => (
            <Route key={source.namehash} exact path={'/' + source.namehash}>
              <Details key="details">
                {React.createElement(markdown(source.content), { key: source.namehash })}
                <Comments {...options} filename={source.name} history={history} />
              </Details>
              <RightContent />
            </Route>
          ))}
        </Switch>
    </React.Fragment>
  );
})([
  <% for (const source of sources) { %>
    { content: require('<%= source.filepath %>'), namehash: '<%= source.namehash %>', name: '<%= source.name %>' },
  <% } %>
])
