import * as React from 'react';
import {
  Switch,
  Route,
  Link,
  useHistory
} from "react-router-dom";
import { Synopsis, Details, Card, TagListPanel } from '@components/styled';
import Comments from '@comments/Comments';
import { TagsCard } from '@app/tags';
import { IntroductionList } from '@components/introduction';

function getClient() {
  const host = window.location.host;
  const options = { owner: 'ybonest', repo: 'note-site' };
  if (host === 'localhost:8080') {
    Object.assign(options, {
      client_id: 'f67c609c5ee466c83cd2',
      client_secret: 'e956d15ba2761abad52e534424f52ba07ffbdbad',
      redirect_uri: 'http://localhost:8080/'
    }); 
  }
  if (host === 'me.ybonote.cn') {
    Object.assign(options, {
      client_id: '5962d91e68425e69e653',
      client_secret: '3231ff558fe41ba150fb868effdc099b7ac8d864',
      redirect_uri: 'https://me.ybonote.cn/'
    })
  }
  return options;
}

function parserQuery(search = window.location.search):Record<string, string> {
  return search.slice(1).split('&').reduce((collect, item) => {
    const [key, value] = item.split('=');
    collect[key] = value;
    return collect;
  }, {})
}

function markdown(markdown): React.FunctionComponent  {
  return () => {
    return <div dangerouslySetInnerHTML={{ __html: markdown }} />
  }
};

function RightContent() {
  return (
    <Card>
    </Card>
  );
}

export const List = ((sources: Record<string, string>[]): React.FunctionComponent => () => {
  const options = getClient();
  const history = useHistory();
  let code;
  React.useEffect(() => {
    const { origin, search, hash } = window.location;
    code = parserQuery(search).code;
    if (code) {
      sessionStorage.setItem('code', code);
      window.location.href = `${origin}/${hash}`;
    }
  })
  if (!code) {
    code = sessionStorage.getItem('code');
  }
  return (
    <React.Fragment>
      <Switch>
        <Route exact path='/'>
          <TagListPanel>
            <IntroductionList dataSource={sources} />
          </TagListPanel>
          <RightContent />
        </Route>
      </Switch>
        <Switch>
          {sources.map(source => (
            <Route key={source.namehash} exact path={'/' + source.namehash}>
              <Details key="details">
                {React.createElement(markdown(source.content), { key: source.namehash })}
                <Comments {...options} filename={source.name} history={history} code={code} />
              </Details>
              <TagsCard />
            </Route>
          ))}
        </Switch>
    </React.Fragment>
  );
})([
  <% for (const source of sources) { %>
    { 
      content: require('<%= source.filepath %>'),
      namehash: '<%= source.namehash %>',
      name: '<%= source.name %>',
      title: '<%= source.headers.title %>',
      description: '<%= source.headers.description %>',
      image: '<%= source.headers.image.name %>'
    },
  <% } %>
])
